name: PR Change Summary & Code Review (OpenAI)

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  summarize-and-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install openai requests

      - name: Get commit info
        id: info
        run: |
          echo "date=$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          title=$(echo "${{ github.event.pull_request.title }}" | tr ' ' '-' | tr -cd '[:alnum:]-')
          echo "title=${title}" >> $GITHUB_OUTPUT

      - name: Extract diff
        env:
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
        run: |
          echo "ğŸ“Œ Base branch: $BASE_BRANCH"
          git fetch origin $BASE_BRANCH
          git diff origin/$BASE_BRANCH...HEAD > diff.patch

      - name: AI Summary & File-by-File Review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          date: ${{ steps.info.outputs.date }}
          sha: ${{ steps.info.outputs.sha }}
          title: ${{ steps.info.outputs.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          COMMIT_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          python - <<'PYCODE'
          import os, openai, pathlib, requests, json, re

          openai.api_key = os.environ["OPENAI_API_KEY"]
          github_token = os.environ["GITHUB_TOKEN"]
          repo = os.environ["REPO"]
          pr_number = os.environ["PR_NUMBER"]
          commit_sha = os.environ["COMMIT_SHA"]

          diff = open("diff.patch").read()
          if not diff.strip():
              print("âš ï¸ No diff to summarize.")
              exit(0)

          # ========================================
          # 1. ì „ì²´ ìš”ì•½ ìƒì„± (ê¸°ì¡´ ê¸°ëŠ¥)
          # ========================================
          print("ğŸ“ Generating summary...")
          summary_prompt = f"""
          You are a senior software engineer reviewing a Git diff.
          Analyze the following diff and produce TWO sections:
          1. Korean summary titled "ğŸ§  ë³€ê²½ ìš”ì•½ (Korean)"  
             - Summarize in fluent professional Korean.  
             - Include sections: ê°œìš”, ë³€ê²½ íŒŒì¼, ì£¼ìš” ë³€ê²½ ë‚´ìš©, ì˜í–¥ ë° ë¦¬ìŠ¤í¬.
          2. English summary titled "ğŸ’¬ Change Summary (English)"  
             - Include sections: Overview, Changed Files, Key Changes, Impact/Risks.
          Keep both versions clear, concise, and structured in Markdown format.

          Diff:
          {diff[:15000]}
          """

          summary_resp = openai.chat.completions.create(
              model="gpt-4o-mini",
              messages=[{"role": "user", "content": summary_prompt}]
          )
          summary = summary_resp.choices[0].message.content.strip()

          # ìš”ì•½ íŒŒì¼ ì €ì¥
          date = os.getenv("date")
          sha = os.getenv("sha")
          title = os.getenv("title")
          filename = f"changes/{date}-{sha}-{title}.md"

          pathlib.Path("changes").mkdir(exist_ok=True)
          with open(filename, "w") as f:
              f.write(summary)

          # index.md ì—…ë°ì´íŠ¸
          index_path = pathlib.Path("changes/index.md")
          link_line = f"- [{date} {title}](./{date}-{sha}-{title}.md)"

          if index_path.exists():
              lines = index_path.read_text().splitlines()
          else:
              lines = ["# Change Index", ""]

          if link_line not in lines:
              lines.append(link_line)

          header, items = lines[0], [l for l in lines[1:] if l.strip()]
          items_sorted = sorted(items, key=lambda x: x.split()[1] if len(x.split()) > 1 else "", reverse=True)

          index_path.write_text("\n".join([header, ""] + items_sorted) + "\n")
          print(f"âœ… Summary created: {filename}")

          # ========================================
          # 2. íŒŒì¼ë³„ ìƒì„¸ ë¦¬ë·° (ì‹ ê·œ ê¸°ëŠ¥)
          # ========================================
          print("\nğŸ” Starting file-by-file code review...")
          
          headers = {
              "Authorization": f"token {github_token}",
              "Accept": "application/vnd.github.v3+json"
          }

          # PRì˜ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          files_url = f"https://api.github.com/repos/{repo}/pulls/{pr_number}/files"
          files_resp = requests.get(files_url, headers=headers)
          
          if files_resp.status_code != 200:
              print(f"âŒ Failed to fetch files: {files_resp.status_code}")
              exit(0)
          
          files = files_resp.json()
          file_reviews = []

          # ë¦¬ë·°í•  íŒŒì¼ í™•ì¥ì í•„í„°
          reviewable_extensions = ['.py', '.js', '.ts', '.tsx', '.jsx', '.java', '.go', '.rb', '.php', '.c', '.cpp', '.cs', '.yaml', '.yml', '.json']

          reviewed_count = 0
          for file in files:
              # ì‚­ì œëœ íŒŒì¼ì´ë‚˜ ë°”ì´ë„ˆë¦¬ íŒŒì¼ ìŠ¤í‚µ
              if file['status'] == 'removed' or file.get('binary'):
                  continue
              
              filename = file['filename']
              patch = file.get('patch', '')
              
              if not patch:
                  continue

              # í™•ì¥ì ì²´í¬
              if not any(filename.endswith(ext) for ext in reviewable_extensions):
                  print(f"â­ï¸  Skipping {filename} (not reviewable extension)")
                  continue

              # API ë¹„ìš© ì ˆê°: ìµœëŒ€ 10ê°œ íŒŒì¼ë§Œ ë¦¬ë·°
              if reviewed_count >= 10:
                  print(f"âš ï¸  Reached review limit (10 files)")
                  break

              print(f"ğŸ” Reviewing: {filename}")
              reviewed_count += 1

              # íŒŒì¼ë³„ AI ë¦¬ë·° ìš”ì²­
              review_prompt = f"""
              You are an expert code reviewer. Review this file change carefully.

              Provide a structured review in Korean with these sections:

              ### ğŸ“‹ íŒŒì¼ ê°œìš”
              - ì´ íŒŒì¼ì˜ ì£¼ìš” ë³€ê²½ì‚¬í•­ì„ 1-2ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½

              ### âœ… ì˜ëœ ì 
              - ì¢‹ì€ ì½”ë”© ê´€í–‰ì´ë‚˜ ê°œì„ ì‚¬í•­ (ìˆë‹¤ë©´)

              ### ğŸ› ë°œê²¬ëœ ì´ìŠˆ
              - ë²„ê·¸, ì ì¬ì  ë¬¸ì œ, ì—ëŸ¬ ì²˜ë¦¬ ëˆ„ë½ ë“±
              - ê° ì´ìŠˆë§ˆë‹¤ ì‹¬ê°ë„ í‘œì‹œ: [CRITICAL], [WARNING], [INFO]

              ### ğŸ’¡ ê°œì„  ì œì•ˆ
              - ì„±ëŠ¥, ê°€ë…ì„±, ìœ ì§€ë³´ìˆ˜ì„± ê°œì„  ë°©ì•ˆ

              ### ğŸ”’ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­
              - ë³´ì•ˆ ì·¨ì•½ì  (ìˆë‹¤ë©´)

              Be specific and constructive. Use code examples if helpful.
              If there are no issues, be encouraging but still provide valuable insights.

              File: {filename}
              Changes:
              {patch[:4000]}
              """

              try:
                  review_resp = openai.chat.completions.create(
                      model="gpt-4o-mini",
                      messages=[{"role": "user", "content": review_prompt}],
                      temperature=0.3
                  )
                  
                  review_text = review_resp.choices[0].message.content.strip()
                  
                  file_reviews.append({
                      "filename": filename,
                      "review": review_text,
                      "additions": file.get('additions', 0),
                      "deletions": file.get('deletions', 0)
                  })
                  
                  print(f"  âœ… Review completed for {filename}")
              
              except Exception as e:
                  print(f"  âŒ Error reviewing {filename}: {e}")
                  continue

          # ========================================
          # 3. ë¦¬ë·° ê²°ê³¼ë¥¼ PRì— ì½”ë©˜íŠ¸ë¡œ ì‘ì„±
          # ========================================
          if file_reviews:
              print(f"\nğŸ’¬ Posting review for {len(file_reviews)} files...")
              
              # ì „ì²´ ë¦¬ë·° ì½”ë©˜íŠ¸ êµ¬ì„±
              review_body = "## ğŸ¤– AI Code Review\n\n"
              review_body += f"**ì´ {len(file_reviews)}ê°œ íŒŒì¼ ë¦¬ë·° ì™„ë£Œ**\n\n"
              review_body += "---\n\n"
              
              for file_review in file_reviews:
                  review_body += f"## ğŸ“„ `{file_review['filename']}`\n"
                  review_body += f"*+{file_review['additions']} -{file_review['deletions']}*\n\n"
                  review_body += f"{file_review['review']}\n\n"
                  review_body += "---\n\n"
              
              review_body += "\n*ğŸ”® This review was automatically generated by OpenAI GPT-4o-mini.*\n"
              review_body += "*Please verify all suggestions before applying changes.*"

              # PRì— ì½”ë©˜íŠ¸ ì‘ì„±
              comment_url = f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments"
              comment_resp = requests.post(
                  comment_url,
                  headers=headers,
                  json={"body": review_body}
              )
              
              if comment_resp.status_code == 201:
                  print(f"âœ… Code review posted to PR!")
              else:
                  print(f"âŒ Failed to post review: {comment_resp.status_code}")
                  print(comment_resp.text)
          else:
              print("âš ï¸ No files to review (or all files were skipped)")

          print("\nğŸ‰ All tasks completed!")
          PYCODE

      - name: Commit and push summary + index
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add changes/
          if git diff --staged --quiet; then
            echo "ğŸ“­ No changes to commit"
          else
            git commit -m "chore: add bilingual AI summary and update index [skip ci]"
            git push
          fi

      - name: Comment index.md to PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: "ğŸ§¾ Change Index"
          path: changes/index.md
